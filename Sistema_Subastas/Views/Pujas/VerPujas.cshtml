@using Sistema_Subastas.Models
@{
    ViewBag.Title = "Detalles del Artículo y Pujas";
    var articulo = ViewBag.Articulos as articulos;
    var imagenes = ViewBag.Imagenes as List<imagenes_articulos>;
    var historialPujas = ViewBag.HistorialPujas as List<dynamic>;
    int? usuarioId = ViewBag.UsuarioId;
}

<div class="container mt-4">
    <h2>@articulo.titulo</h2>

    <div class="row">
        <div class="col-md-6">
            @if (imagenes != null && imagenes.Any())
            {
                <div id="carouselImagenes" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @for (int i = 0; i < imagenes.Count; i++)
                        {
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <img src="@imagenes[i].url_imagen" class="d-block w-100 rounded" alt="Imagen @i" style="height: 300px; object-fit: cover;">
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselImagenes" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselImagenes" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
            }
            else
            {
                <p class="text-muted">Sin imágenes disponibles.</p>
            }
        </div>

        <div class="col-md-6">
            <h5>Descripción</h5>
            <p>@articulo.descripcion</p>

            <h5>Precio de salida:</h5>
            <p>$@articulo.precio_salida</p>

            <h5>Estado:</h5>
            <p>
                @if (articulo.estado == "activa")
                {
                    <span class="badge bg-success">Activa</span>
                }
                else
                {
                    <span class="badge bg-danger">Finalizada</span>
                }
            </p>

            <h5>Fecha límite:</h5>
            <p>@articulo.fecha_fin.ToString("dd/MM/yyyy HH:mm")</p>
        </div>
    </div>

    <hr />

    @if (TempData["Exito"] != null)
    {
        <div class="alert alert-success">@TempData["Exito"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <h4 class="mt-4">Historial de pujas</h4>

    @if (articulo.visualizacion_puja.ToLower() == "cerrado")
    {
        <div class="alert alert-warning">El historial de pujas está cerrado para este artículo.</div>
    }
    else if (historialPujas != null && historialPujas.Any())
    {
        <table class="table table-bordered mt-3">
            <thead class="table-success">
                <tr>
                    <th>Monto</th>
                    <th>Usuario</th>
                    <th>Fecha</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var puja in historialPujas)
                {
                    <tr>
                        <td>$@puja.Valor</td>
                        <td>@puja.nombre_usuario</td>
                        <td>@puja.Fecha.ToString("g")</td>
                        <td>
                            @if (puja.id_usuario == usuarioId && articulo.estado == "activa")
                            {
                                <form asp-action="CancelarPuja" asp-route-id="@puja.id_puja" method="post" onsubmit="return confirm('¿Estás seguro de cancelar esta puja?');">
                                    <button type="submit" class="btn btn-danger btn-sm btn-cancelar"
                                            data-id-puja="@puja.id_puja"
                                            data-id-usuario="@puja.id_usuario"
                                            data-estado-subasta="@articulo.estado">
                                        Cancelar
                                    </button>
                                </form>
                            }
                            else if (puja.id_usuario == usuarioId && articulo.estado != "activa")
                            {
                                <span class="text-muted">Subasta finalizada</span>
                            }
                            else
                            {
                                <span class="text-muted">Sin acción</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">Aún no hay pujas registradas.</p>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var cancelButtons = document.querySelectorAll(".btn-cancelar");

            cancelButtons.forEach(function (button) {
                button.addEventListener("click", function (e) {
                    var idPuja = button.getAttribute("data-id-puja");
                    var idUsuario = button.getAttribute("data-id-usuario");
                    var estadoSubasta = button.getAttribute("data-estado-subasta");

                    var usuarioLogueado = '@(ViewBag.UsuarioId ?? "0")';

                    if (idUsuario !== usuarioLogueado) {
                        alert("No puedes cancelar esta puja porque no eres el propietario.");
                        e.preventDefault();
                        return;
                    }

                    if (estadoSubasta !== "activa") {
                        alert("No se puede cancelar la puja porque la subasta ya ha finalizado.");
                        e.preventDefault();
                        return;
                    }

                    if (!confirm("¿Estás seguro de que deseas cancelar esta puja?")) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
}
